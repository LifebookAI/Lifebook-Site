name: e2e-pr-smoke
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  e2e:
    name: e2e
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      AWS_OIDC_ROLE_ARN: ${{ secrets.AWS_OIDC_ROLE_ARN }}
      PRESIGN_API_BASE:  ${{ secrets.PRESIGN_API_BASE }}
      PRESIGN_API_KEY:   ${{ secrets.PRESIGN_API_KEY }}
      PRESIGN_HMAC_SECRET: ${{ secrets.PRESIGN_HMAC_SECRET }}
      CF_BASE_URL:       ${{ secrets.CF_BASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS creds via OIDC
        if: ${{ env.AWS_OIDC_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          : "${PRESIGN_API_BASE:?}"; : "${PRESIGN_API_KEY:?}"; : "${PRESIGN_HMAC_SECRET:?}"; : "${CF_BASE_URL:?}"

      - name: Presign → PUT → GET via CloudFront
        shell: bash
        run: |
          set -euo pipefail
          TS=$(date +%s)
          BODY='{"key":"sources/smoke/pr-'"$GITHUB_RUN_ID"'.txt","contentType":"text/plain","contentDisposition":"inline"}'

          # Detect HMAC key format: hex / base64 / utf8
          KEY_MODE=$(python3 - "$PRESIGN_HMAC_SECRET" <<'PY'
import sys, re, base64
s=sys.argv[1]
if re.fullmatch(r"[0-9a-fA-F]{64}", s): print("hex")
else:
  try:
    base64.b64decode(s, validate=True); print("b64")
  except Exception:
    print("utf8")
PY
)
          echo "Using HMAC key mode: $KEY_MODE"

          SIG=$(python3 - "$KEY_MODE" "$TS" "$BODY" "$PRESIGN_HMAC_SECRET" <<'PY'
import sys, hmac, hashlib, base64
mode, ts, body, key = sys.argv[1:5]
if mode=="hex":
  k=bytes.fromhex(key)
elif mode=="b64":
  import base64 as b64; k=b64.b64decode(key)
else:
  k=key.encode()
print(hmac.new(k, f"{ts}.{body}".encode(), hashlib.sha256).hexdigest())
PY
)

          code=$(curl --silent --show-error --fail-with-body \
            -o /tmp/presign.json -w '%{http_code}' \
            -X POST "$PRESIGN_API_BASE/presign" \
            -H "x-api-key: $PRESIGN_API_KEY" \
            -H "x-timestamp: $TS" \
            -H "x-signature: $SIG" \
            -H "content-type: application/json" \
            -d "$BODY" || true)

          echo "presign HTTP=$code"
          sed -e 's/[A-Za-z0-9_]\{24,\}/[redacted]/g' /tmp/presign.json || true
          test "$code" = "200"

          URL=$(jq -r .url /tmp/presign.json)
          echo "Presign URL obtained: ${URL%%\?*}"

          echo "hello from e2e smoke $GITHUB_RUN_ID" > /tmp/smoke.txt
          curl -sfS -X PUT -T /tmp/smoke.txt "$URL" -H "x-amz-server-side-encryption: AES256"

          KEY=$(python3 -c 'import sys; from urllib.parse import urlparse; p=urlparse(sys.argv[1]).path; print(p.split("/",3)[-1])' "$URL")
          GET_URL="${CF_BASE_URL%/}/$KEY"
          echo "Verifying via CloudFront: $GET_URL"
          curl -sfS "$GET_URL" | tee /tmp/fetched.txt
          grep -q "hello from e2e smoke" /tmp/fetched.txt
