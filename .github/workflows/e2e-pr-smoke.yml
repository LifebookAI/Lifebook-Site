name: e2e-pr-smoke
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
permissions:
  id-token: write
  contents: read
env:
  AWS_REGION: us-east-1
jobs:
  e2e:
    name: e2e
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Only assume AWS role if the secret exists
      - name: Configure AWS creds via OIDC
        if: ${{ secrets.AWS_OIDC_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Presign → PUT → GET via CloudFront
        shell: bash
        env:
          PRESIGN_API_BASE: ${{ secrets.PRESIGN_API_BASE }}
          PRESIGN_API_KEY:  ${{ secrets.PRESIGN_API_KEY }}
          PRESIGN_HMAC_SECRET: ${{ secrets.PRESIGN_HMAC_SECRET }}
          CF_BASE_URL: ${{ secrets.CF_BASE_URL }}
        run: |
          set -euo pipefail
          TS=$(date +%s)
          BODY='{"key":"sources/smoke/pr-'"$GITHUB_RUN_ID"'.txt","contentType":"text/plain","contentDisposition":"inline"}'

          SIG=$(python3 -c "import os,hmac,hashlib;print(hmac.new(bytes.fromhex(os.environ['PRESIGN_HMAC_SECRET']),f\"{os.environ['TS']}.{os.environ['BODY']}\".encode(),hashlib.sha256).hexdigest())")

          URL=$(curl -sfS -X POST "$PRESIGN_API_BASE/presign" \
            -H "x-api-key: $PRESIGN_API_KEY" \
            -H "x-timestamp: $TS" \
            -H "x-signature: $SIG" \
            -H "content-type: application/json" \
            -d "$BODY" | jq -r .url)

          echo "Presign URL obtained"
          echo "hello from e2e smoke $GITHUB_RUN_ID" > /tmp/smoke.txt
          curl -sfS -X PUT -T /tmp/smoke.txt "$URL" -H "x-amz-server-side-encryption: AES256"

          KEY=$(python3 -c 'import sys; from urllib.parse import urlparse; p=urlparse(sys.argv[1]).path; print(p.split("/",3)[-1])' "$URL")
          GET_URL="${CF_BASE_URL%/}/$KEY"
          echo "Verifying via CloudFront: $GET_URL"
          curl -sfS "$GET_URL" | tee /tmp/fetched.txt
          grep -q "hello from e2e smoke" /tmp/fetched.txt
