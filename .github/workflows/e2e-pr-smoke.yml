name: E2E smoke (PR)
on:
  pull_request:
    types: [opened, synchronize, reopened]
permissions:
  id-token: write
  contents: read
env:
  AWS_REGION: us-east-1
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS creds via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Presign → PUT → GET via CloudFront
        shell: bash
        env:
          PRESIGN_API_BASE: ${{ secrets.PRESIGN_API_BASE }}
          PRESIGN_API_KEY:  ${{ secrets.PRESIGN_API_KEY }}
          PRESIGN_HMAC_SECRET: ${{ secrets.PRESIGN_HMAC_SECRET }}
          CF_BASE_URL: ${{ secrets.CF_BASE_URL }}
        run: |
          set -euo pipefail
          TS=$(date +%s)
          BODY='{"key":"sources/smoke/pr-'"$GITHUB_RUN_ID"'.txt","contentType":"text/plain","contentDisposition":"inline"}'
          SIG=$(python3 - <<'PY'
import os, hmac, hashlib
ts=os.environ["TS"]; body=os.environ["BODY"]; key=bytes.fromhex(os.environ["PRESIGN_HMAC_SECRET"])
msg=f"{ts}.{body}".encode()
print(hmac.new(key, msg, hashlib.sha256).hexdigest())
PY
)
          URL=$(curl -sfS -X POST "$PRESIGN_API_BASE/presign" \
            -H "x-api-key: $PRESIGN_API_KEY" \
            -H "x-timestamp: $TS" \
            -H "x-signature: $SIG" \
            -H "content-type: application/json" \
            -d "$BODY" | jq -r .url)

          echo "Presign URL obtained"
          echo "hello from e2e smoke $GITHUB_RUN_ID" > /tmp/smoke.txt
          curl -sfS -X PUT -T /tmp/smoke.txt "$URL" -H "x-amz-server-side-encryption: AES256"

          KEY=$(python3 -c 'import json,sys; from urllib.parse import urlparse; u=sys.argv[1]; p=urlparse(u).path; print(p.split("/",3)[-1])' "$URL")
          GET_URL="${CF_BASE_URL%/}/$KEY"
          echo "Verifying via CloudFront: $GET_URL"
          curl -sfS "$GET_URL" | tee /tmp/fetched.txt
          grep -q "hello from e2e smoke" /tmp/fetched.txt
