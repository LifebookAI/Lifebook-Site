name: view-protect (branch protection audit)
on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
permissions:
  contents: read
  actions: read
  administration: read
jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch protection
        uses: actions/github-script@v7
        with:
          script: |
            const branch = 'main';
            const expectedContexts = ["pre-commit","CodeQL","EOL guard (LF only)"];
            function require(cond, msg){ if(!cond){ core.setFailed(msg); throw new Error(msg); } }

            const prot = await github.request('GET /repos/{owner}/{repo}/branches/{branch}/protection', {
              owner: context.repo.owner, repo: context.repo.repo, branch
            });

            const p = prot.data;
            const strict   = p.required_status_checks?.strict === true;
            const contexts = p.required_status_checks?.contexts || [];
            const admins   = p.enforce_admins?.enabled === true;
            const linear   = p.required_linear_history?.enabled === true;
            const convRes  = p.required_conversation_resolution?.enabled === true;
            const reviews  = p.required_pull_request_reviews?.required_approving_review_count ?? 0;
            const dismiss  = p.required_pull_request_reviews?.dismiss_stale_reviews === true;

            // Required signed commits (200 or 204 => enabled)
            let signaturesEnabled = false;
            try {
              await github.request('GET /repos/{owner}/{repo}/branches/{branch}/protection/required_signatures', {
                owner: context.repo.owner, repo: context.repo.repo, branch
              });
              signaturesEnabled = true;
            } catch (e) {
              if (e.status === 204) signaturesEnabled = true;
            }

            const missing = expectedContexts.filter(c => !contexts.includes(c));

            core.info(`strict=${strict} admins=${admins} linear=${linear} convRes=${convRes} reviews=${reviews} dismissStale=${dismiss} signatures=${signaturesEnabled}`);
            core.info(`contexts=[${contexts.join(', ')}] expected=[${expectedContexts.join(', ')}]`);

            require(strict, 'Required status checks must be strict.');
            require(admins, 'Admins enforcement must be enabled.');
            require(linear, 'Linear history must be enabled.');
            require(convRes, 'Conversation resolution must be enabled.');
            require(signaturesEnabled, 'Required signed commits must be enabled.');
            require(reviews >= 1 && dismiss, 'At least 1 approving review and dismiss stale reviews are required.');
            require(missing.length === 0, `Missing required check contexts: ${missing.join(', ')}`);

            core.notice('Branch protection audit passed.');
