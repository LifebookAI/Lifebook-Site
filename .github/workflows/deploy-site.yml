name: Deploy site (PowerShell)
on:
  push:
    branches: [ main ]
permissions:
  contents: read
  id-token: write
jobs:
  deploy:
    name: Sync + set HTML no-cache + CF invalidation
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}->${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Sync all files (SSE enforced)
        shell: pwsh
        run: |
          aws s3 sync ${{ env.SITE_DIR }} "s3://${{ vars.BUCKET }}/" --delete --sse AES256 --only-show-errors
      - name: Set no-cache on HTML (keep proper content-type)
        shell: pwsh
        run: |
          Get-ChildItem -Path ${{ env.SITE_DIR }} -Recurse -Filter *.html | ForEach-Object {
            $rel = $_.FullName.Substring((Resolve-Path ${{ env.SITE_DIR }}).Path.Length).TrimStart('\','/')
            aws s3 cp $_.FullName "s3://${{ vars.BUCKET }}/$rel" `
              --cache-control "no-cache, no-store, must-revalidate" `
              --metadata-directive REPLACE `
              --only-show-errors
          }
      - name: CloudFront invalidation
        shell: pwsh
        run: |
          aws cloudfront create-invalidation `
            --distribution-id ${{ vars.CF_DIST_ID }} `
            --paths "/index.html" "/404.html" "/robots.txt" "/*" | Out-Null
