name: Deploy site (PowerShell)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: site-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Validate site folder exists
        shell: pwsh
        run: |
          if (-not (Test-Path 'site')) { Write-Error 'site/ folder not found'; exit 1 }
          Write-Host 'site/ found' -ForegroundColor Green

      - name: Upload index.html (no-cache)
        shell: pwsh
        run: |
          $bucket = "${{ vars.S3_BUCKET }}"
          aws s3 cp "site/index.html" "s3://$bucket/index.html" ` --sse aws:kms --sse-kms-key-id '${{ vars.S3_KMS_KEY_ARN }}'
            --cache-control "no-cache, must-revalidate" `
            --content-type "text/html" `
          --sse aws:kms `
          --sse-kms-key-id '${{ vars.S3_KMS_KEY_ARN }}'
          --sse aws:kms `
          --sse-kms-key-id '${{ vars.S3_KMS_KEY_ARN }}'
          --sse aws:kms `
          --sse-kms-key-id '${{ vars.S3_KMS_KEY_ARN }}'
          Write-Host "Uploaded index.html with no-cache" -ForegroundColor Green

      - name: Upload assets (immutable cache)
        shell: pwsh
        run: |
          $bucket = "${{ vars.S3_BUCKET }}"
          aws s3 sync site/ "s3://$bucket" `
            --exclude "index.html" `
            --cache-control "public, max-age=31536000, immutable"
          Write-Host "Assets synced with long cache" -ForegroundColor Green

      - name: Invalidate CloudFront
        shell: pwsh
        run: |
          $dist = "${{ vars.CF_DIST_ID }}"
          aws cloudfront create-invalidation --distribution-id $dist --paths "/index.html" "/"
          Write-Host "Invalidation requested" -ForegroundColor Green
