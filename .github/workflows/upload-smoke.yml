name: Upload smoke
on:
  workflow_dispatch:

jobs:
  presign_and_upload:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Normalize secrets -> env (strip CR/LF and trim)
      - name: Sanity-check inputs (masked)
        shell: pwsh
        run: |
          $envPath = $env:GITHUB_ENV

          $apiBase = "${{ secrets.PRESIGN_API_BASE }}".Trim()
          $apiKey  = "${{ secrets.PRESIGN_API_KEY }}".Replace("`r","").Replace("`n","").Trim()
          $secret  = "${{ secrets.PRESIGN_HMAC_SECRET }}".Replace("`r","").Replace("`n","").Trim()

          # Write sanitized values for later steps
          "PRESIGN_API_BASE=$apiBase" | Out-File -FilePath $envPath -Encoding utf8 -Append
          "PRESIGN_API_KEY=$apiKey"   | Out-File -FilePath $envPath -Encoding utf8 -Append
          "PRESIGN_HMAC_SECRET=$secret" | Out-File -FilePath $envPath -Encoding utf8 -Append

          Write-Host ("API_BASE length: {0}" -f $apiBase.Length)
          Write-Host ("API_KEY  length: {0}" -f $apiKey.Length)
          Write-Host ("SECRET  length: {0}" -f $secret.Length)

      - name: Presign and upload
        shell: pwsh
        run: .github/workflows/scripts/presign-smoke.ps1

      - name: Show generated URL (if any)
        if: success() || failure()
        shell: pwsh
        run: |
          if (Test-Path $env:TEMP\presign-url.txt) {
            Get-Content $env:TEMP\presign-url.txt
          } else {
            Write-Host "No URL file produced."
          }
