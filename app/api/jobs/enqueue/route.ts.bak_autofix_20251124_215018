import { NextRequest, NextResponse } from "next/server";
import { POST as createJob } from "../route";

type EnqueueBody = {
  templateId?: string;
  workflowTemplateId?: string;
  journeyKey?: string;
  metadata?: Record<string, unknown>;
  input?: unknown;
};

export async function POST(req: NextRequest) {
  let body: EnqueueBody;

  try {
    body = (await req.json()) as EnqueueBody;
  } catch {
    return NextResponse.json(
      { error: "Invalid JSON body" },
      { status: 400 },
    );
  }

  const templateId = body.templateId ?? body.workflowTemplateId;

  if (!templateId) {
    return NextResponse.json(
      { error: "Missing templateId/workflowTemplateId" },
      { status: 400 },
    );
  }

  // Normalize into the shape expected by /api/jobs
  const forwardBody = {
    templateId,
    journeyKey: body.journeyKey,
    metadata: body.metadata,
    input: body.input,
  };

  const targetUrl = new URL("/api/jobs", req.url);

  const forwardReq = new NextRequest(
    new Request(targetUrl.toString(), {
      method: "POST",
      headers: {
        "content-type": "application/json",
      },
      body: JSON.stringify(forwardBody),
    }),
  );

  // Delegate to the main /api/jobs POST handler
  return createJob(forwardReq);
}
