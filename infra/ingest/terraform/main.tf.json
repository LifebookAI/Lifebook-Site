{
  "provider": {
    "aws": [
      {
        "profile": "lifebook-sso",
        "region": "us-east-1",
        "default_tags": [
          {
            "tags": {
              "Env": "prod",
              "Project": "lifebook"
            }
          }
        ]
      }
    ]
  },
  "terraform": {
    "required_providers": {
      "aws": {
        "source": "hashicorp/aws",
        "version": "~> 5.0"
      }
    }
  },
  "resource": {
    "aws_cloudwatch_log_group": {
      "_aws_lambda_lifebook_ingest": {
        "name": "/aws/lambda/lifebook-ingest",
        "retention_in_days": 60
      }
    },
    "aws_cloudwatch_composite_alarm": {
      "lifebook_ingest_incident": {
        "actions_enabled": true,
        "alarm_name": "lifebook-ingest-incident",
        "alarm_rule": "ALARM(\"lifebook-ingest-errors-5m\") OR ALARM(\"lifebook-ingest-throttles-5m\") OR ALARM(\"lifebook-ingest-quiet-15m\")",
        "alarm_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "ok_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "alarm_description": "Overall ingest incident: ALARM if Errors OR Throttles OR 15m Quiet.",
        "tags": {
          "Purpose": "ingest-overall"
        }
      }
    },
    "aws_cloudwatch_metric_alarm": {
      "lifebook_ingest_errors_5m": {
        "dimensions": {
          "FunctionName": "lifebook-ingest"
        },
        "comparison_operator": "GreaterThanThreshold",
        "threshold": 0.0,
        "evaluation_periods": 5,
        "ok_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "insufficient_data_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "alarm_description": "Fires if AWS/Lambda:Errors for lifebook-ingest >0 in any 1 of 5 minutes. TreatMissing=notBreaching.",
        "alarm_name": "lifebook-ingest-errors-5m",
        "namespace": "AWS/Lambda",
        "datapoints_to_alarm": 1,
        "tags": {
          "Purpose": "ingest"
        },
        "metric_name": "Errors",
        "period": 60,
        "statistic": "Sum",
        "alarm_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "treat_missing_data": "notBreaching"
      },
      "lifebook_ingest_quiet_15m": {
        "dimensions": {
          "FunctionName": "lifebook-ingest"
        },
        "comparison_operator": "LessThanThreshold",
        "threshold": 1.0,
        "evaluation_periods": 15,
        "ok_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "insufficient_data_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "alarm_description": "Fires if AWS/Lambda:Invocations for lifebook-ingest are <1 for 15 consecutive minutes. TreatMissing=breaching. Actions -> lifebook-alerts.",
        "alarm_name": "lifebook-ingest-quiet-15m",
        "namespace": "AWS/Lambda",
        "datapoints_to_alarm": 15,
        "tags": {
          "Purpose": "ingest-quiet"
        },
        "metric_name": "Invocations",
        "period": 60,
        "statistic": "Sum",
        "alarm_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "treat_missing_data": "breaching"
      },
      "lifebook_ingest_throttles_5m": {
        "dimensions": {
          "FunctionName": "lifebook-ingest"
        },
        "comparison_operator": "GreaterThanThreshold",
        "threshold": 0.0,
        "evaluation_periods": 5,
        "ok_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "insufficient_data_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "alarm_description": "Fires if AWS/Lambda:Throttles for lifebook-ingest >0 in any 1 of 5 minutes. TreatMissing=notBreaching.",
        "alarm_name": "lifebook-ingest-throttles-5m",
        "namespace": "AWS/Lambda",
        "datapoints_to_alarm": 1,
        "tags": {
          "Purpose": "ingest"
        },
        "metric_name": "Throttles",
        "period": 60,
        "statistic": "Sum",
        "alarm_actions": [
          "arn:aws:sns:us-east-1:354630286254:lifebook-alerts"
        ],
        "treat_missing_data": "notBreaching"
      }
    },
    "aws_lambda_permission": {
      "perm_lifebook_ingest_s3_lifebook_ai": {
        "source_arn": "arn:aws:s3:::lifebook.ai",
        "principal": "s3.amazonaws.com",
        "statement_id": "s3invoke-e280def1",
        "action": "lambda:InvokeFunction",
        "function_name": "lifebook-ingest"
      }
    },
    "aws_cloudwatch_dashboard": {
      "Lifebook_Ingest_Overview": {
        "dashboard_body": "{\"widgets\": [\r\n  {\r\n    \"type\": \"alarm\",\r\n    \"x\": 0,\r\n    \"y\": 0,\r\n    \"width\": 24,\r\n    \"height\": 4,\r\n    \"properties\": {\r\n      \"title\": \"Ingest - INCIDENT (composite)\",\r\n      \"alarms\": [\r\n        \"arn:aws:cloudwatch:us-east-1:354630286254:alarm:lifebook-ingest-incident\"\r\n      ]\r\n    }\r\n  },\r\n  {\r\n    \"type\": \"alarm\",\r\n    \"x\": 0,\r\n    \"y\": 4,\r\n    \"width\": 24,\r\n    \"height\": 4,\r\n    \"properties\": {\r\n      \"title\": \"Ingest - component alarms\",\r\n      \"alarms\": [\r\n        \"arn:aws:cloudwatch:us-east-1:354630286254:alarm:lifebook-ingest-quiet-15m\",\r\n        \"arn:aws:cloudwatch:us-east-1:354630286254:alarm:lifebook-ingest-errors-5m\",\r\n        \"arn:aws:cloudwatch:us-east-1:354630286254:alarm:lifebook-ingest-throttles-5m\"\r\n      ]\r\n    }\r\n  },\r\n  {\r\n    \"type\": \"metric\",\r\n    \"x\": 0,\r\n    \"y\": 8,\r\n    \"width\": 24,\r\n    \"height\": 8,\r\n    \"properties\": {\r\n      \"view\": \"timeSeries\",\r\n      \"stacked\": false,\r\n      \"region\": \"us-east-1\",\r\n      \"title\": \"lifebook-ingest - Invocations / Errors / Throttles (Sum, 60s)\",\r\n      \"metrics\": [\r\n        [\r\n          \"AWS/Lambda\",\r\n          \"Invocations\",\r\n          \"FunctionName\",\r\n          \"lifebook-ingest\",\r\n          {\r\n            \"stat\": \"Sum\",\r\n            \"period\": 60\r\n          }\r\n        ],\r\n        [\r\n          \"AWS/Lambda\",\r\n          \"Errors\",\r\n          \"FunctionName\",\r\n          \"lifebook-ingest\",\r\n          {\r\n            \"stat\": \"Sum\",\r\n            \"period\": 60\r\n          }\r\n        ],\r\n        [\r\n          \"AWS/Lambda\",\r\n          \"Throttles\",\r\n          \"FunctionName\",\r\n          \"lifebook-ingest\",\r\n          {\r\n            \"stat\": \"Sum\",\r\n            \"period\": 60\r\n          }\r\n        ]\r\n      ]\r\n    }\r\n  },\r\n  {\r\n    \"type\": \"log\",\r\n    \"x\": 0,\r\n    \"y\": 16,\r\n    \"width\": 24,\r\n    \"height\": 7,\r\n    \"properties\": {\r\n      \"region\": \"us-east-1\",\r\n      \"title\": \"lifebook-ingest - recent errors (Logs Insights)\",\r\n      \"query\": \"SOURCE '/aws/lambda/lifebook-ingest' | filter @message like /(?i)(error|exception|fail)/ | fields @timestamp, @message, @logStream | sort @timestamp desc | limit 50\"\r\n    }\r\n  }\r\n,\n  {\n  \"type\": \"metric\",\n  \"x\": 0, \"y\": 23, \"width\": 12, \"height\": 6,\n  \"properties\": {\n    \"title\": \"Ingest DLQ - Visible (1m)\",\n    \"region\": \"us-east-1\",\n    \"stat\": \"Average\",\n    \"period\": 60,\n    \"setPeriodToTimeRange\": false,\n    \"sparkline\": false,\n    \"view\": \"timeSeries\",\n    \"stacked\": false,\n    \"legend\": { \"position\": \"bottom\" },\n    \"metrics\": [\n      [\"AWS/SQS\",\"ApproximateNumberOfMessagesVisible\",\"QueueName\",\"lifebook-ingest-dlq\"]\n    ]\n  }\n},\n  {\n  \"type\": \"metric\",\n  \"x\": 0, \"y\": 29, \"width\": 12, \"height\": 6,\n  \"properties\": {\n    \"title\": \"Ingest DLQ - OldestAge (1m)\",\n    \"region\": \"us-east-1\",\n    \"stat\": \"Maximum\",\n    \"period\": 60,\n    \"setPeriodToTimeRange\": false,\n    \"sparkline\": false,\n    \"view\": \"timeSeries\",\n    \"stacked\": false,\n    \"legend\": { \"position\": \"bottom\" },\n    \"metrics\": [\n      [\"AWS/SQS\",\"ApproximateAgeOfOldestMessage\",\"QueueName\",\"lifebook-ingest-dlq\"]\n    ]\n  }\n}\n] }",
        "dashboard_name": "Lifebook-Ingest-Overview"
      }
    }
  }
}
